name: CI

'on':
  pull_request:
  push:
    branches: [ "main", "master" ]

permissions:
  contents: read
  security-events: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          python -m pip install ruff

      - name: Lint (ruff)
        run: |
          ruff check .

      - name: Smoke (compileall)
        run: |
          python -m compileall .
  secret_scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
         fetch-depth: 0
      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  pii_scan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PII scan (lightweight)
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          python - <<'PY'
          import os, re, sys, subprocess
          from collections import defaultdict

          base = os.environ["BASE_SHA"]
          head = os.environ["HEAD_SHA"]

          diff = subprocess.check_output(
            ["git", "diff", "--unified=0", "--diff-filter=ACMR", f"{base}...{head}"],
            text=True, encoding="utf-8", errors="replace"
          )

          skip_ext = {
            ".png",".jpg",".jpeg",".gif",".bmp",".pdf",".zip",".gz",".tar",".7z",
            ".ico",".mp3",".mp4",".wav",".mov",".avi",".exe",".dll",".so",".dylib",".bin"
          }

          # allowlist: примеры и редактированные значения
          allow = {"example.com", "REDACTED", "redacted", "0000000000", "+10000000000"}

          email_re = re.compile(r"\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b", re.I)
          ssn_re   = re.compile(r"\b\d{3}-\d{2}-\d{4}\b")
          phone_re = re.compile(r"(?<!\w)(?:\+?\d[\d\s().-]{8,}\d)(?!\w)")

          def scrub(s: str) -> str:
            for a in allow:
              s = s.replace(a, "")
            return s

          # Собираем только добавленные строки по каждому файлу
          added = []  # (file, line)
          current = None
          for line in diff.splitlines():
             if line.startswith("+++ b/"):
                  p = line[6:].strip()
                  current = None if p == "/dev/null" else p
                  continue
             if not current:
                 continue
             if line.startswith("+") and not line.startswith("+++"):
                  added.append((current, line[1:]))

             if not added:
                print("PII scan: OK (no added lines in diff).")
                sys.exit(0)

             hits = defaultdict(int)

             for f, line in added:
               ext = os.path.splitext(f)[1].lower()
               if ext in skip_ext:
                  continue

               s = scrub(line)

               hits[(f, "email")] += sum(1 for _ in email_re.finditer(s))
               hits[(f, "ssn")]   += sum(1 for _ in ssn_re.finditer(s))

               for m in phone_re.finditer(s):
                 val = m.group(0).strip()
                 digits = re.sub(r"\D", "", val)
                 if 10 <= len(digits) <= 15:
                    hits[(f, "phone")] += 1

          # Оставляем только реально найденные
          hits = {k:v for k,v in hits.items() if v > 0}

          if hits:
             print("PII-like patterns detected in ADDED lines (values redacted):")
             for (f, t), c in sorted(hits.items()):
                print(f"- {f}: {t}: {c} hit(s)")
             sys.exit(1)

          print("PII scan: OK (no hits in added lines).")
          PY
